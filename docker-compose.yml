services:
  postgresql:
    image: postgres:16.3-alpine
    container_name: mayan-postgresql
    environment:
      - POSTGRES_DB=mayan
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=@edDGA6QCID9K$$22
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 30s
      timeout: 30s
      retries: 3
    restart: always
    volumes:
      - pgdata:/var/lib/postgresql/data
    networks:
      - mayan_network

  redis:
    image: redis:7.2-alpine
    container_name: mayan-redis
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5
    restart: always
    volumes:
      - cache:/data
    networks:
      - mayan_network

  mayan-app:
    image: mayanedms/mayanedms:s4.10
    container_name: mayan-app
    depends_on:
      postgresql:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      MAYAN_CELERY_BROKER_URL: redis://redis:6379/3
      MAYAN_CELERY_RESULT_BACKEND: redis://redis:6379/4
      MAYAN_DATABASES: "{'default':{'ENGINE':'django.db.backends.postgresql','NAME':'mayan','PASSWORD':'@edDGA6QCID9K$$22','USER':'postgres','HOST':'postgresql','PORT':5432}}"
      MAYAN_GUNICORN_TIMEOUT: 120
      MAYAN_ALLOWED_HOSTS: "['localhost', '127.0.0.1', '*']"
      MAYAN_CSRF_TRUSTED_ORIGINS: "['http://localhost:8070', 'http://127.0.0.1:8070']"
      # --- CUSTOM APP SETTINGS ---
      PYTHONPATH: "/var/lib/mayan"
      MAYAN_COMMON_EXTRA_APPS: |
        - events_document_id_fix
      # ---------------------------
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8070/ || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 10
    ports:
      - "8070:8000"
    volumes:
      - mayan_app:/var/lib/mayan
      - ./custom_apps/events_document_id_fix:/var/lib/mayan/events_document_id_fix
    restart: unless-stopped
    networks:
      - mayan_network

  mayan-proxy:
    image: python:3.11-slim
    container_name: mayan-proxy
    depends_on:
      - mayan-app
    environment:
      - PROXY_PORT=8075
      - TARGET_URL=http://mayan-app:8000
      - DB_HOST=postgresql
      - DB_PORT=5432
      - DB_NAME=mayan
      - DB_USER=postgres
      - DB_PASSWORD=@edDGA6QCID9K$$22
    command: ["sh", "-c", "pip install -q psycopg2-binary requests && python /proxy/mayan_proxy.py"]
    volumes:
      - ./mayan_proxy.py:/proxy/mayan_proxy.py
    ports:
      - "8075:8075"
    restart: unless-stopped
    networks:
      - mayan_network

networks:
  mayan_network:
    driver: bridge

volumes:
  pgdata:
  cache:
  mayan_app:
